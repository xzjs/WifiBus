<div class="out_container_title">
    <div class="container_title">
        <div class="left">
            <ul>
                <li class="box_one"><a></a></li>
                <li class="box_two"><a></a></li>
            </ul>
            <div class="weather" id="weather">
            
            
            
            </div>
        </div>
        <div id="allmap" class="main"></div>
        <div class="right">
            <div class="show-legend"><a>显示图例</a></div>
            <div class="hide-legend"><a>隐藏图例</a></div>
            <div class="clr"></div>
            <ul>
                <li><img src="__PUBLIC__/images/G_car.png" alt=""> <img
                        src="__PUBLIC__/images/G_point.png" alt="">

                    <p>正在运营</p></li>
                <li class="clear"></li>
                <li><img src="__PUBLIC__/images/R_car.png" alt=""> <img
                        src="__PUBLIC__/images/R_point.png" alt="">

                    <p>暂停运营</p></li>
                <li class="clear"></li>
            </ul>
        </div>
        <div class="clr"></div>
        <div class="footer" id="pie-index">
            <ul>
                <li id="workNormal"></li>
                <li id="onlinePeople"></li>
                <li id="flow"></li>
                <li id="adClick"></li>
                <div class="clr"></div>
            </ul>
        </div>
        <div class="display">
            <select id="line_selector" onchange="get_bus_list_line('{:U('Bus/select')}',this.value,'bus_no_selector')">
                <volist name="line_list" id="vo" empty=" ">
                    <option value={$vo.id}>{$vo.name}</option>
                </volist>
            </select>

            <div class="search">
                <p>
                    <input type="text" id="search_keys"> <a><img
                        src="__PUBLIC__/images/home_search.png" alt=""
                        onclick="search_bus_index('{:U('Bus/select')}',$('#search_keys').val())"></a>
                </p>
            </div>
            <ul class="select" id="bus_no_selector">
                <volist name="bus_list" id="vo" empty=" ">
                
                    <li><a href="#" onclick="show_bus('__CONTROLLER__/bus/str/{$vo.id}/flag/0','')">{$vo.no}</a></li>
                </volist>
            </ul>
        </div>

        <div class="road_display">
            <div class="left_display">
                <ul>
                	<volist name="line_list" id="vo" empty=" ">
                  	  <li><a href="javascript:void(0);"
                           onclick="show_line('__CONTROLLER__/bus/str/{$vo.id}/flag/1','{$vo.name}')">{$vo.name}</a></li>
                	</volist>
                </ul>
            </div>
        </div>
    </div>
    <div class="clear"></div>
    <div class="address-footer">
        <p>版权:青岛智能产业技术研究院</p>
        <p>2015 all rights reserved</p>
    </div>
</div>
<script type="text/javascript" src="__PUBLIC__/js/echarts-all.js"></script>
<script type="text/javascript">
	
/**
 * ajax获取天气
 */
$(function () {

    $.post("{:U('Weather/get_weather')}", {
        city_code: 370200,
    }, function (datas, status) {
        if (status == 4 || status == "success") {
            $("div#weather").html(datas);

        }
    });
})
    var myChartWork = echarts.init(document.getElementById('workNormal'));
    var myChartOnline = echarts.init(document.getElementById('onlinePeople'));
    var myChartFlow = echarts.init(document.getElementById('flow'));
    var myChartAd = echarts.init(document.getElementById('adClick'));

    var a = 70;
    var b = 35;
    var c = 30;
    var d = 40;
    var line;
    
    function ajax($url, line) {
    	//alert($url);
        jQuery.ajax({
              url: $url,
              dataType: "json",
              success: function (results) {
              	map.clearOverlays()
              //	alert($url);
              	var data=eval(results);
              	
                  get_map(line,data );
                  
              }
          });
      }
      var ding_id;
      ding_id=setInterval(
    		  function (){ajax("__CONTROLLER__/all", '')},
              5000
      );
    
     
      function get_map(line, array) {
      	
          	//alert("纯首页无条件");
                      var x;
                       for (x in array) {
                          var a = array[x]['p_x'];
                          var b = array[x]['p_y'];
                          var pt = new BMap.Point(a, b);
                          var num = array[x]['flag'];
                          var img;
                          switch (num) {
                              case 0:
                                  img = "__PUBLIC__/images/green_left.png";
                                  break;
                              case 1:
                                  img = "__PUBLIC__/images/red_left.png";
                                  break;
                              
                              default :
                                  img = "__PUBLIC__/images/green_right.png";
                                  break;
                          }
                          var myIcon = new BMap.Icon(img, new BMap.Size(50, 20));
                          var marker2 = new BMap.Marker(pt, {icon: myIcon});  // 创建标注
                          map.addOverlay(marker2);
                       //  alert("dd"); // 创建标注
                        
                          	 var content =  '<div style="margin:0;line-height:20px;padding:2px;font-size: 12px">'
                          		 + '公交车牌号：'
                    				+  array[x]['car_no']	
                          	    + '<br/>在线人数：'
                   				+  array[x]['online_num']
                   				+ '<br/>已用流量：'
                   				+  array[x]['flow_num']
                   				+ '<br/>磁盘使用率：' 
                   				+  array[x]['cipan_use']
                                  +'<br/>本地资源访问人数：'
                   				+ 1
                   				+'</div>';
                          addClickHandler(content, marker2);
                      }
              
      }
   
    var int = self.setInterval("chart()", 3000); 
    var line;
    function show_bus($url, line) {
	   	 clearInterval(ding_id);
	   	 
	    	//alert($url);
	        jQuery.ajax({
	              url: $url,
	              dataType: "json",
	              success: function (results) {
	              	map.clearOverlays()
	              //	alert($url);
	              	var data=eval(results);
	              	
	                  get_map(line,data );
	                  
	              }
	          });
	        ding_id=setInterval(
	       		  function (){show_bus($url, line)},
	                 5000
	         );
	      }
 function show_line($url, line) {
	 line=line;
	// alert("线路循环");
	 clearInterval(ding_id);
    jQuery.ajax({
        url: $url,
        dataType: "json",
        success: function (results) {
        	map.clearOverlays()
       // 	alert($url);
        	var data=eval(results);
        	get_map_line(line,data );
        		
        }
    });
    ding_id=setInterval(
     		  function (){show_line($url, line)},
               5000
       );
}
    var map = new BMap.Map("allmap");            // 创建Map实例
    map.centerAndZoom(new BMap.Point(120.183995, 35.948858), 13);
     var opts = {
        width: 250,     // 信息窗口宽度
        height: 140,     // 信息窗口高度
        title: "公交状况", // 信息窗口标题
        enableMessage: true//设置允许信息窗发送短息
    };

    function chart() {
        // 正在工作设备量
        var num = Math.random();
      
        num = 0.5 - num;
        a += num;
        var optionWork = workOption(a, "__CONTROLLER__/work/f/work/num/" + a);
        //在线人数
        b += num;
        var optionOnline = onlineOption(b, "__CONTROLLER__/work/f/online/num/" + b);
        // 流量
        c += 0.01;
        if(c>85){
            c=30;
        }
        var optionFlow = flowOption(c, "__CONTROLLER__/work/f/flow/num/" + c);
        // 广告点击量
        d += num;
        var optionAd = adOption(d, "__CONTROLLER__/work/f/ad/num/" + d);
       myChartWork.setOption(optionWork);
       myChartOnline.setOption(optionOnline);
       myChartFlow.setOption(optionFlow);
       myChartAd.setOption(optionAd);
    }
   
   

    function addClickHandler(content, marker) {
        marker.addEventListener("click", function (e) {
                    openInfo(content, e)
                }
        );
    }
    function get_map_line(line, array) {
    	
        // 百度地图API功能

        var busline = new BMap.BusLineSearch(map, {
            renderOptions: {map: map, panel: "r-result"},
            onGetBusListComplete: function (result) {
                if (result) {
                    var fstLine = result.getBusListItem(0);//获取第一个公交列表显示到map上
                    busline.getBusLine(fstLine);
                }
            }
        });

        function busSearch() {
            var busName = line;
            busline.getBusList(busName);
        }
         busSearch();
         setTimeout(
        		 function () {
        			 //alert("线路");
                    var x;
                     for (x in array) {
                        var a = array[x]['p_x'];
                        var b = array[x]['p_y'];
                    //  	
                        var pt = new BMap.Point(a, b);
                        var num = array[x]['flag'];
                        var img;
                        switch (num) {
                            case 0:
                                img = "__PUBLIC__/images/green_left.png";
                                break;
                            case 1:
                                img = "__PUBLIC__/images/red_left.png";
                                break;
                            
                            default :
                                img = "__PUBLIC__/images/green_right.png";
                                break;
                        }
                        var myIcon = new BMap.Icon(img, new BMap.Size(50, 20));
                        var marker2 = new BMap.Marker(pt, {icon: myIcon});  // 创建标注
                        map.addOverlay(marker2);
                     //  alert("dd"); // 创建标注
                      
                        	 var content =  '<div style="margin:0;line-height:20px;padding:2px;font-size: 12px">'
                        		 + '公交车牌号：'
                  				+  array[x]['car_no']	
                        	    + '<br/>在线人数：'
                 				+  array[x]['online_num']
                 				+ '<br/>已用流量：'
                 				+  array[x]['flow_num']
                 				+ '<br/>磁盘使用率：' 
                 				+  array[x]['cipan_use']
                                +'<br/>本地资源访问人数：'
                 				+ 1
                 				+'</div>';
                        addClickHandler(content, marker2);
                    }
         },800);
        
        
    }

    function addClickHandler(content, marker) {
        marker.addEventListener("click", function (e) {
                    openInfo(content, e)
                }
        );
    }
    function openInfo(content, e) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content, opts);  // 创建信息窗口对象
       
        map.openInfoWindow(infoWindow, point); //开启信息窗口
    }
</script>